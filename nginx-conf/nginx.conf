events {
    worker_connections 1024;
}

http {
    # 1️⃣ General protection
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=60r/m;   # 60 req/min per IP
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;           # limit concurrent connections

    # 2️⃣ Security headers
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;   # enforce HTTPS
    add_header Referrer-Policy no-referrer always;
    add_header Feature-Policy "none" always;

    # # 3️⃣ Buffer & body limits
    client_body_buffer_size 128k;
    client_max_body_size 25M;                 # adjust to your file‑upload limits

    # 4️⃣ HTTPS (replace with your cert/key paths)
    server {
        listen 8080;
        # ssl_certificate /etc/ssl/certs/ollama.crt;
        # ssl_certificate_key /etc/ssl/private/ollama.key;
        # ssl_protocols TLSv1.2 TLSv1.3;
        # ssl_prefer_server_ciphers on;

        # rate & connection limits
        # limit_req zone=req_limit_per_ip burst=20 nodelay;
        # limit_conn zone=conn_limit_per_ip 20;

        # allow only safe HTTP methods
        if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }

        location / {
            proxy_pass http://webui:8080;   # Ollama web UI
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_cache_bypass $http_upgrade;

            # WebSocket support (Ollama may use it)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Optional: serve static files directly (if any)
        location /static/ {
            alias /var/www/ollama/static/;
            expires 30d;
            add_header Cache-Control public;
        }
    }
}
